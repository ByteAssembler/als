---
import Layout from "../../layouts/Layout.astro";
import { fetchDataFromServer } from "../../pages/api/trpc/serverHelpers";

const { lang, site_slug } = Astro.params;

const site = await fetchDataFromServer("site.read_by_slug", site_slug, lang);
});

if (!site) {
    return new Response(`Site ${site_slug} Not Found`, { status: 404 });
}

function prepareHtml(html: string, content: { [key: string]: string }) {
    for (const key in content) {
        html = html.replaceAll(`{{${key}}}`, content[key]);
    }
    return html;
}
---

<Layout title="" defaultPadding={false}>
    <main>
        <h1>{site.title}</h1>
        {
            site.sections.map((section) => {
                // get proper lang content
                const sectionContent = section.contents.find((content) => content.langCode === lang);

                if (!sectionContent) {
                    return (
                        <section class="w-full bg-red-400 p-9">
                            <h2 class="text-center">Content not found for lang: {lang}</h2>
                        </section>
                    );
                }

                const htmlEverythingSet = prepareHtml(
                    section.html,
                    (sectionContent?.content as {
                        [key: string]: string;
                    }) || ({} as { [key: string]: string })
                );

                return (
                    <>
                        <style set:html={section.css} />
                        <section set:html={htmlEverythingSet} />
                    </>
                );
            })
        }
    </main>
</Layout>
